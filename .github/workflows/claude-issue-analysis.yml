name: Claude Issue Analysis

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  analyze-issue:
    name: Analyze Issue with Claude
    runs-on: ubuntu-latest
    # Only run if issue has 'needs-analysis' label or contains certain keywords
    if: |
      contains(github.event.issue.labels.*.name, 'needs-analysis') ||
      contains(github.event.issue.labels.*.name, 'bug') ||
      contains(github.event.issue.labels.*.name, 'enhancement')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze issue with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ö†Ô∏è ANTHROPIC_API_KEY not set. Skipping analysis."
            exit 0
          fi

          cat > analyze_issue.js << 'SCRIPT'
          const https = require('https');
          const fs = require('fs');

          const API_KEY = process.env.ANTHROPIC_API_KEY;
          const title = process.env.ISSUE_TITLE;
          const body = process.env.ISSUE_BODY || 'No description provided';
          const labels = process.env.ISSUE_LABELS;

          const isBug = labels.includes('bug');
          const isEnhancement = labels.includes('enhancement');

          let analysisType = 'general analysis';
          if (isBug) analysisType = 'bug investigation';
          if (isEnhancement) analysisType = 'feature design';

          const prompt = `You are an expert developer for a VS Code extension that builds autonomous AI coding agents.

          Analyze this GitHub issue and provide a helpful response:

          **Issue Title:** ${title}
          **Issue Type:** ${analysisType}
          **Labels:** ${labels}

          **Issue Description:**
          ${body}

          **Project Context:**
          - This is a VS Code extension written in TypeScript
          - Uses multi-agent system with orchestrator pattern
          - Integrates with HuggingFace for AI models
          - Supports MCP (Model Context Protocol) tools
          - Has safety guardrails and loop detection
          - Can build full React+Supabase apps from descriptions

          ${isBug ? `
          For this bug, provide:
          1. **Root Cause Analysis** - Likely cause based on description
          2. **Reproduction Steps** - How to reproduce (if not provided)
          3. **Suggested Fix** - Code location and approach to fix
          4. **Related Components** - Which files/systems are affected
          5. **Testing Guidance** - How to verify the fix
          ` : ''}

          ${isEnhancement ? `
          For this feature request, provide:
          1. **Design Approach** - Recommended implementation strategy
          2. **Architecture Impact** - Which components need changes
          3. **Edge Cases** - Potential issues to consider
          4. **Testing Strategy** - How to test the feature
          5. **Alternatives** - Other ways to achieve this goal
          ` : ''}

          Be specific, actionable, and reference actual code patterns used in the project.
          Provide markdown-formatted response with clear sections.`;

          const data = JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 4096,
            messages: [{
              role: 'user',
              content: prompt
            }]
          });

          const options = {
            hostname: 'api.anthropic.com',
            port: 443,
            path: '/v1/messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': API_KEY,
              'anthropic-version': '2023-06-01'
            }
          };

          const req = https.request(options, (res) => {
            let responseBody = '';
            res.on('data', (chunk) => responseBody += chunk);
            res.on('end', () => {
              if (res.statusCode === 200) {
                const response = JSON.parse(responseBody);
                const analysis = response.content[0].text;
                fs.writeFileSync('analysis.txt', analysis);
                console.log('Analysis generated successfully');
              } else {
                console.error('API Error:', responseBody);
                process.exit(1);
              }
            });
          });

          req.on('error', (e) => {
            console.error('Request error:', e);
            process.exit(1);
          });

          req.write(data);
          req.end();
          SCRIPT

          node analyze_issue.js || echo "‚ö†Ô∏è Analysis failed"

      - name: Post analysis comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let analysis = '';
            try {
              analysis = fs.readFileSync('analysis.txt', 'utf-8');
            } catch (e) {
              console.log('No analysis file found, skipping...');
              return;
            }

            const body = `## ü§ñ Claude AI Analysis

            ${analysis}

            ---

            *This analysis was automatically generated by Claude Sonnet 4.*

            üí° **Next Steps:**
            - Review the analysis and add your thoughts
            - Update issue labels if needed
            - Reference this analysis when implementing

            ü§ù **Collaboration:**
            - Use \`/claude\` in comments to request follow-up analysis
            - Tag specific files/components for focused review
            - Add \`needs-analysis\` label to trigger re-analysis

            üîß To disable auto-analysis, remove the trigger labels or \`ANTHROPIC_API_KEY\`.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

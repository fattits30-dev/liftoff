# .liftoff Directory Structure Implementation

## Overview

Implemented a proper `.liftoff/` directory structure to consolidate all Liftoff-related files, context, and state information in one organized location.

## Problem Solved

Previously, `.liftoff` was a single JSON file and `lessons.json` attempted to save to `.liftoff/lessons.json` but the directory didn't exist, causing crashes. Spec and architecture files were scattered in the project root.

## New Directory Structure

```
.liftoff/
├── plan.json          - Main plan file (phases, progress, features)
├── spec.json          - Generated specification
├── architecture.json  - System architecture
├── lessons.json       - Lessons learned (managed by LessonsManager)
├── context.md         - Human-readable implementation notes
└── status.json        - Current build status snapshot
```

## Files Created

### src/appBuilder/liftoffDirectory.ts (NEW)
**Purpose:** Manages the .liftoff directory structure with a clean API

**Key Methods:**
- `initialize()` - Creates .liftoff directory
- `savePlan(plan)` / `loadPlan()` - Plan file management
- `saveSpec(spec)` / `loadSpec()` - Spec file management
- `saveArchitecture(arch)` / `loadArchitecture()` - Architecture file management
- `appendContext(heading, content)` - Add implementation notes
- `updateStatus(status)` / `loadStatus()` - Status snapshot management
- `initializeContext(description, spec)` - Create initial context.md
- `getSummary()` - Get directory contents summary

**Benefits:**
- Type-safe file operations
- Centralized path management
- Automatic date deserialization
- Error handling built-in
- Clean separation of concerns

## Files Modified

### src/appBuilder/appBuilderOrchestrator.ts
**Changes:**
1. Added `LiftoffDirectory` import
2. Added `liftoffDir` field to class
3. Updated `buildApp()` to:
   - Initialize .liftoff directory at start
   - Use `liftoffDir.savePlan()` instead of `saveLiftoffPlan()`
   - Save spec to `.liftoff/spec.json`
   - Save architecture to `.liftoff/architecture.json`
   - Create and update `context.md` with implementation notes
   - Update artifact paths to point inside `.liftoff/`
4. Updated `saveLiftoffPlan()` and `loadLiftoffPlan()` to use LiftoffDirectory (kept for backward compatibility)

**Context Tracking:**
- **Spec Phase:** Records project overview and stack details
- **Architecture Phase:** Records table/page/route counts
- **Scaffold Phase:** Records project structure creation
- **Implementation Phase:** Records completed features and TODO count

### src/mainOrchestrator.ts
**Changes:**
- Updated all orchestrator prompts to reference `.liftoff/plan.json` instead of `.liftoff`
- Updated instructions to say "Create .liftoff directory structure" instead of "Create .liftoff file"
- Updated tool call examples to use `.liftoff/plan.json` path

**Affected Sections:**
- "CRITICAL: CHECK FOR .liftoff PLAN FILE FIRST"
- Example interactions
- Instructions for updating plan after phases

## Benefits

### 1. Organized Context Storage
All build-related files are now in one directory instead of scattered across the project root.

### 2. Lessons.json Fix
The directory is created at build start, so lessons.json saves no longer crash.

### 3. Human-Readable Context
`context.md` provides a timeline of implementation decisions in markdown format that agents can read for context.

### 4. Status Snapshots
`status.json` provides quick access to current phase, progress percentage, active agents, and blockers.

### 5. Clean Project Root
Only actual project files in root; all Liftoff metadata is contained in `.liftoff/`

### 6. Better Agent Context
Agents can read `.liftoff/context.md` to understand what's been done and why certain decisions were made.

## Example .liftoff/context.md

```markdown
# Implementation Context

This file tracks key decisions, patterns, and notes during the build process.

## Project Overview

**Description:** A recipe app with meal planning

**Stack:**
- Frontend: react
- Bundler: vite
- Styling: tailwind
- Backend: supabase
- Database: postgresql
- Auth: supabase-auth
- Hosting: vercel

**Features:** auth, database, file-upload

**Entities:** Recipe, MealPlan, Ingredient, User

## Build Started
*2025-12-01T18:15:30.000Z*

## Architecture Completed
*2025-12-01T18:17:45.000Z*

Generated 4 tables, 6 pages, and 8 API routes.

## Scaffold Completed
*2025-12-01T18:20:15.000Z*

Project structure created with react + supabase.

## Implementation Completed
*2025-12-01T18:45:30.000Z*

Built 12 features. TODO items: 3.
```

## Example .liftoff/status.json

```json
{
  "currentPhase": "implement",
  "phaseProgress": 75,
  "lastUpdated": "2025-12-01T18:40:00.000Z",
  "activeAgents": ["frontend-agent", "backend-agent"],
  "completedTasks": 18,
  "totalTasks": 24,
  "blockers": []
}
```

## Migration Path

### For New Projects
- `.liftoff/` directory is created automatically on first build
- All files go into the directory from the start

### For Existing Projects
- Old `.liftoff` file (if it exists as a file) is ignored
- New `.liftoff/plan.json` takes precedence
- `loadLiftoffPlan()` automatically uses the new directory structure

### Backward Compatibility
- `saveLiftoffPlan()` and `loadLiftoffPlan()` still work but internally use LiftoffDirectory
- No breaking changes to the API

## Testing

Verified TypeScript compilation:
```bash
npx tsc --noEmit  # ✓ No errors
```

## Next Steps (Optional Enhancements)

1. **Add .gitignore entry:** Users might want to exclude `.liftoff/` from git (or commit it for team context)
2. **Periodic status updates:** Auto-update status.json during long operations
3. **Context search:** Allow agents to query context.md for specific topics
4. **Backup/restore:** Save snapshots of `.liftoff/` directory at key milestones
5. **Visual summary:** Add a CLI command to show `.liftoff/` directory tree

## Files to Review

- `src/appBuilder/liftoffDirectory.ts` - New directory manager
- `src/appBuilder/appBuilderOrchestrator.ts` - Updated to use directory
- `src/mainOrchestrator.ts` - Updated prompts
- `src/tools/lessons.ts` - Already references `.liftoff/lessons.json` (now works!)

---

**Implementation Date:** December 1, 2025
**Status:** ✅ Complete and tested
